<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Complaint Information</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #888;
            width: 100%;
            max-width: 600px;
            height: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: slide-down 0.5s ease-out;
        }

        @keyframes slide-down {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>

<body class="overflow-y-auto bg-gray-100 p-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
            <!-- Complaint Information Section -->
            <div class="p-3 mb-4 bg-white rounded-lg shadow-xl">
                <button onclick="goBack()"
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </button>
                <h2 class="text-center text-blue-600 font-bold text-xl mb-3">
                    Complaint Information
                </h2>
                <div class="h-[230px] overflow-y-auto grid grid-cols-2 gap-3">
                    <div class="bg-blue-100 p-3 rounded-lg shadow-md">
                        <span class="font-semibold">
                            Complaint ID:
                        </span>
                        Loading...
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg shadow-md">
                        <span class="font-semibold">
                            Product ID:
                        </span>
                        Loading...
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg shadow-md">
                        <span class="font-semibold">
                            Product Name:
                        </span>
                        Loading...
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg shadow-md">
                        <span class="font-semibold">
                            Date Raised:
                        </span>
                        Loading...
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg shadow-md">
                        <span class="font-semibold">
                            Complaint Type:
                        </span>
                        Loading...
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg shadow-md">
                        <span class="font-semibold">
                            Status:
                        </span>
                        Loading...
                    </div>
                    <div class="bg-blue-100 p-3 col-span-2 rounded-lg shadow-md">
                        <span class="font-semibold">
                            Description:
                        </span>
                        Loading...
                    </div>
                </div>
            </div>
            <!-- Followbacks Section -->
            <div class="p-4 bg-white rounded-lg shadow-xl">
                <h2 class="text-center text-green-600 font-bold text-xl mb-4">
                    Resolutions
                </h2>
                <div class="space-y-4 h-[250px] overflow-y-auto">
                    <!-- Dynamic follow-up -->
                </div>
            </div>
        </div>
        <div class="flex flex-col space-y-4">
            <!-- Chat with Support Section -->
            <div class="p-4 bg-white rounded-lg shadow-xl flex flex-col justify-between flex-grow">
                <h2 class="text-center text-purple-600 font-bold text-xl mb-4">
                    Chat with Customer
                </h2>
                <div class="h-full overflow-y-auto bg-white p-4 rounded-lg shadow-lg flex-grow">
                    <div class="flex items-center mb-4">
                        <img alt="Support Icon" class="w-10 h-10 rounded-full mr-2" height="50"
                            src="https://firebasestorage.googleapis.com/v0/b/tunnel-ac8de.appspot.com/o/icons%2Fuser%20login.jpg?alt=media&amp;token=c5dfd901-a74f-4c67-b896-87485f69f684"
                            width="50" />
                        <div class="bg-purple-100 p-3 rounded-lg shadow-md">
                            Hello! How can I assist you with your complaint today?
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2 mb-4">
                        <button
                            class="bg-purple-100 p-3 rounded-lg shadow-md text-left hover:bg-purple-200 transition duration-300">
                            Check Complaint Status
                        </button>
                        <button
                            class="bg-purple-100 p-3 rounded-lg shadow-md text-left hover:bg-purple-200 transition duration-300">
                            Speak to an Customer
                        </button>
                        <button
                            class="bg-purple-100 p-3 rounded-lg shadow-md text-left hover:bg-purple-200 transition duration-300">
                            Other Queries
                        </button>
                    </div>
                </div>
                <div class="flex items-center mt-4">
                    <input class="flex-grow p-3 border rounded-l-lg shadow-md" placeholder="Type your message..."
                        type="text" />
                    <button
                        class="bg-purple-600 text-white p-3 rounded-r-lg shadow-md hover:bg-purple-700 transition duration-300">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            <!-- Action Buttons Section -->
            <div class="p-4 bg-white rounded-lg shadow-xl relative flex justify-center space-x-4">
                <button
                    class="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105"
                    onclick="document.getElementById('followbackModal').style.display='block'">
                    <i class="fas fa-plus mr-2"></i>Resolution
                </button>
                <button onclick="markAsResolved()"
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105">
                    <i class="fas fa-check mr-2"></i>Mark as Resolved
                </button>
            </div>
        </div>
    </div>
    <!-- Followback Modal -->

    <div class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75 hidden modal"
        id="followbackModal">
        <div
            class="relative mx-auto p-5 border w-10/12 sm:w-[30rem] shadow-lg rounded-lg bg-white modal-content transform transition-all duration-300 ease-in-out">
            <div class="overflow-y-auto max-h-full px-6 py-4">
                <!-- Close Button -->
                <button
                    class="absolute top-3 right-5 sm:right-8 text-gray-600 hover:text-gray-800 text-xl font-bold focus:outline-none"
                    onclick="document.getElementById('followbackModal').style.display='none'">Ã—</button>

                <!-- Modal Title -->
                <h2 class="text-center text-green-600 font-extrabold text-2xl mb-4">Resolution</h2>

                <!-- Form -->
                <form id="followbackForm" class="space-y-3">
                    <!-- Followback Number -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-1" for="followbackNumber">Followback
                            Number</label>
                        <input
                            class="w-full p-2 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-600 focus:border-green-600"
                            id="followbackNumber" name="followbackNumber" type="text"
                            placeholder="Enter followback number" required />
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-1" for="description">Description</label>
                        <textarea
                            class="w-full p-2 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-600 focus:border-green-600"
                            id="description" name="description" rows="2" placeholder="Enter description"
                            required></textarea>
                    </div>

                    <!-- Followback Given By -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-1" for="followbackGivenBy">Followback Given
                            By</label>
                        <input
                            class="w-full p-2 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-600 focus:border-green-600"
                            id="followbackGivenBy" name="followbackGivenBy" type="text" placeholder="Enter name"
                            required />
                    </div>

                    <!-- Contact -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-1" for="contact">Contact</label>
                        <input
                            class="w-full p-2 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-600 focus:border-green-600"
                            id="contact" name="contact" type="text" placeholder="Enter contact details" required />
                    </div>

                    <!-- Remark -->
                    <div>
                        <label class="block text-gray-700 font-semibold mb-1" for="remark">Remark</label>
                        <textarea
                            class="w-full p-2 border-2 border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-600 focus:border-green-600"
                            id="remark" name="remark" rows="2" placeholder="Enter remarks" required></textarea>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center">
                        <button
                            class="bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105"
                            type="submit">
                            Add Followback
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function goBack() {
            window.history.back(); // Navigate to the previous page
            setTimeout(() => {
                window.location.reload(); // Refresh the page after navigating back
            }, 100); // Delay to ensure the navigation occurs before refresh
        }
        function getComplaintIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('complaint_id');
        }
        async function fetchComplaintData() {
            const complaintId = getComplaintIdFromURL();
            if (!complaintId) {
                alert('Complaint ID not found');
                return;
            }

            try {
                const response = await fetch(`/api/complaint-details/${complaintId}`);
                const data = await response.json();

                if (response.ok) {
                    renderComplaintDetails(data.complaint);
                    renderFollowups(data.followups);
                } else {
                    console.error('Error fetching data:', data.message);
                    alert('Error fetching complaint details. Please try again later.');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Error fetching complaint details. Please try again later.');
            }
        }

        function renderComplaintDetails(complaint) {
            if (!complaint) {
                alert('Complaint details not found.');
                return;
            }

            const complaintInfo = `
        <div class="bg-blue-100 p-3 rounded-lg shadow-md">
            <span class="font-semibold">Complaint ID:</span> ${complaint.id}
        </div>
        <div class="bg-blue-100 p-3 rounded-lg shadow-md">
            <span class="font-semibold">Product ID:</span> ${complaint.product_id}
        </div>
        <div class="bg-blue-100 p-3 rounded-lg shadow-md">
            <span class="font-semibold">Product Name:</span> ${complaint.product_name}
        </div>
        <div class="bg-blue-100 p-3 rounded-lg shadow-md">
            <span class="font-semibold">Date Raised:</span> ${formatDate(complaint.created_at)}
        </div>
        <div class="bg-blue-100 p-3 rounded-lg shadow-md">
            <span class="font-semibold">Complaint Type:</span> ${complaint.complaint_type}
        </div>
        <div class="bg-blue-100 p-3 rounded-lg shadow-md">
            <span class="font-semibold">Status:</span> ${complaint.status}
        </div>
        <div class="bg-blue-100 p-3 col-span-2 rounded-lg shadow-md">
            <span class="font-semibold">Description:</span> ${complaint.issue_description}
        </div>
    `;

            document.querySelector('.grid-cols-2').innerHTML = complaintInfo;
        }

        function renderFollowups(followups) {
            const followupContainer = document.querySelector('.space-y-4');

            if (followups.length === 0) {
                // Show message when there are no follow-ups
                followupContainer.innerHTML = `
            <div class="bg-red-100 p-3 rounded-lg shadow-md flex justify-center items-center h-full">
            <p class="text-red-600 font-semibold">No follow-ups right now.</p>
            </div>
        `;
                return;
            }

            // Render follow-up details
            const followupHTML = followups.map(followup => `
    <div class="bg-green-100 p-4 rounded-lg shadow-md border-l-4 border-green-500 hover:shadow-lg transition duration-300 ease-in-out">
        <p class="mb-3 text-lg font-semibold text-green-800">
            <strong>Follow-up ${followup.followback_number}:</strong> 
        </p>
            <strong>Follow-up ${followup.description}</strong> 
        <div class="mb-2">
            <p class="text-sm text-gray-600">
                <span class="font-medium text-gray-700">Resolved By:</span> ${followup.followback_given_by || 'N/A'}
            </p>
            <p class="text-sm text-gray-600">
                <span class="font-medium text-gray-700">Contact:</span> ${followup.contact || 'N/A'}
            </p>
        </div>
        <p class="text-sm text-gray-500 italic">
            Date: ${formatDate(followup.created_at)}
        </p>
    </div>
`).join('');
            followupContainer.innerHTML = followupHTML;
        }

        // Function to handle form submission
        document.getElementById('followbackForm').addEventListener('submit', async function (event) {
            event.preventDefault();

            // Function to get the complaint ID dynamically (adjust based on your application's URL structure)

            // Get the complaint_id
            const complaint_id = getComplaintIdFromURL();
            if (!complaint_id) {
                alert('Complaint ID is missing or invalid!');
                return;
            }

            // Get the form values
            const followbackNumber = document.getElementById('followbackNumber').value;
            const description = document.getElementById('description').value;
            const followbackGivenBy = document.getElementById('followbackGivenBy').value;
            const contact = document.getElementById('contact').value;
            const remark = document.getElementById('remark').value;

            // Prepare the data to send to the server
            const followbackData = {
                complaint_id: complaint_id,
                followback_number: followbackNumber,
                description: description,
                followback_given_by: followbackGivenBy,
                contact: contact,
                remark: remark,
                created_at: new Date().toISOString(), // Capture the current date and time
            };

            try {
                // Send the data to the backend
                const response = await fetch('/api/add-followback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(followbackData),
                });

                if (response.ok) {
                    alert('Followback added successfully!');
                    document.getElementById('followbackModal').style.display = 'none'; // Close the modal
                    document.getElementById('followbackForm').reset(); // Reset the form
                    fetchComplaintData();

                } else {
                    const errorData = await response.json();
                    alert(`Failed to add followback: ${errorData.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error adding followback:', error);
                alert('An error occurred while adding the followback. Please try again later.');
            }
        });


        async function markAsResolved() {
            const complaint_id = getComplaintIdFromURL();

            if (!complaint_id) {
                alert('Complaint ID is missing or invalid!');
                return;
            }

            try {
                const response = await fetch('/api/resolve-complaint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ complaint_id }),
                });

                if (response.ok) {
                    alert('Complaint marked as resolved successfully!');
                    fetchComplaintData();

                } else {
                    const errorData = await response.json();
                    alert(`Failed to resolve complaint: ${errorData.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error resolving complaint:', error);
                alert('An error occurred while resolving the complaint. Please try again later.');
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are zero-indexed
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year}, Time: ${hours}:${minutes}`;
        }

        document.addEventListener('DOMContentLoaded', fetchComplaintData);


        // Close the modal when clicking outside of it
        window.onclick = function (event) {
            var modal = document.getElementById('followbackModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>

</html>
